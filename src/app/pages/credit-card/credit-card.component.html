<div class="container">
  <div class="header">
    <h2>CartÃµes:</h2>
    <button class="btn-reload" (click)="recarregarDados()" [disabled]="loading">
      <span *ngIf="loading" class="spinning">ðŸ”„</span>
      <span *ngIf="!loading">â†»</span>
      {{ loading ? 'Carregando...' : 'Atualizar' }}
    </button>
  </div>

  <div class="cards" *ngIf="!loading && cartoes.length > 0">
    <div class="card"
         *ngFor="let cartao of cartoes"
         [class.selected]="cartaoSelecionado === cartao.uuid"
         [class.desativado]="!isCartaoAtivo(cartao)">

      <!-- BotÃ£o de ativar/desativar -->
      <button class="btn-toggle-status"
              (click)="toggleCartaoStatus($event, cartao)"
              [title]="isCartaoAtivo(cartao) ? 'Desativar cartÃ£o' : 'Ativar cartÃ£o'">
        <span *ngIf="isCartaoAtivo(cartao)">ðŸ”’</span>
        <span *ngIf="!isCartaoAtivo(cartao)">ðŸ”“</span>
      </button>

      <div class="card-content" (click)="selecionarCartao(cartao.uuid)">
        <div class="card-header">
          <h4>{{ cartao.description }}</h4>
          <span class="badge-desativado" *ngIf="!isCartaoAtivo(cartao)">Desativado</span>
        </div>
        <p class="card-bandeira">{{ cartao.flags.name }}</p>
        <p class="card-limite">Limite: {{ cartao.limite | currency:'BRL':'symbol':'1.2-2' }}</p>
        <p class="card-faturas" *ngIf="cartao.faturas && cartao.faturas.length > 0">
          {{ cartao.faturas.length }} fatura(s)
        </p>
      </div>
    </div>
    <div class="card create-card" routerLink="/create-card">
      <div class="card-content">
        <span class="plus-icon">+</span>
        <span>Criar CartÃ£o</span>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="!loading && cartoes.length === 0">
    <div class="empty-icon">ðŸ’³</div>
    <p>VocÃª ainda nÃ£o possui cartÃµes cadastrados</p>
    <button class="btn-create-first" routerLink="/create-card">
      Criar Primeiro CartÃ£o
    </button>
  </div>

  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Carregando cartÃµes...</p>
  </div>

  <!-- BalÃ£o da fatura que aparece quando um cartÃ£o Ã© selecionado -->
  <div class="fatura" *ngIf="cartaoSelecionado && getFaturaAtual()">
    <!-- Header da fatura com navegaÃ§Ã£o -->
    <div class="fatura-header">
      <button
        class="nav-arrow nav-arrow-left"
        (click)="faturaAnterior()"
        [disabled]="!podeVoltar()"
        [class.disabled]="!podeVoltar()"
        title="Fatura anterior">
        &#8249;
      </button>

      <div class="fatura-title">
        <h3>{{ getNomeCartao() }}</h3>
        <p class="fatura-periodo">{{ getMesAnoFatura() }}</p>
      </div>

      <button
        class="nav-arrow nav-arrow-right"
        (click)="proximaFatura()"
        [disabled]="!podeAvancar()"
        [class.disabled]="!podeAvancar()"
        title="PrÃ³xima fatura">
        &#8250;
      </button>
    </div>

    <!-- InformaÃ§Ãµes da fatura -->
    <div class="fatura-info">
      <div class="fatura-item">
        <span class="label">Valor da Fatura:</span>
        <span class="value valor-fatura" [class]="getStatusFatura().toLowerCase().replace(' ', '-')">
          {{ getFaturaValor() }}
        </span>
      </div>

      <div class="fatura-item">
        <span class="label">Valor Pago:</span>
        <span class="value valor-pago">
          {{ getValorPago() }}
        </span>
      </div>

      <div class="fatura-item">
        <span class="label">Data de Fechamento:</span>
        <span class="value">{{ getDataFechamento() }}</span>
      </div>

      <div class="fatura-item">
        <span class="label">Data de Vencimento:</span>
        <span class="value">{{ getDataVencimento() }}</span>
      </div>

      <div class="fatura-item">
        <span class="label">Limite DisponÃ­vel:</span>
        <span class="value limite">{{ getLimiteDisponivel() }}</span>
      </div>

      <div class="fatura-item">
        <span class="label">Status:</span>
        <span class="value status" [class]="getStatusFatura().toLowerCase().replace(' ', '-')">
          {{ getStatusFatura() }}
        </span>
      </div>
    </div>

    <!-- Indicador de navegaÃ§Ã£o (pontos) -->
    <div class="fatura-indicator" *ngIf="getCartaoSelecionado() && getCartaoSelecionado()!.faturas">
      <span
        *ngFor="let fatura of getCartaoSelecionado()!.faturas; let i = index"
        class="indicator-dot"
        [class.active]="i === faturaAtualIndex"
        [title]="fatura.mes + ' ' + fatura.ano"
        (click)="faturaAtualIndex = i">
      </span>
    </div>

    <!-- AÃ§Ãµes da fatura -->
    <div class="fatura-actions">
      <button
        class="btn-pagar"
        (click)="pagarFatura()"
        [disabled]="getStatusFatura() === 'Pago' || getStatusFatura() === 'Futura'">
        <span *ngIf="getStatusFatura() === 'Pago'">âœ“ Pago</span>
        <span *ngIf="getStatusFatura() === 'Futura'">Fatura Futura</span>
        <span *ngIf="getStatusFatura() === 'Fechamento Pendente'">Pagar PendÃªncia</span>
        <span *ngIf="getStatusFatura() === 'Em aberto'">Pagar Fatura</span>
      </button>

      <button class="btn-detalhes" (click)="verDetalhes()">
        Ver Detalhes
      </button>

      <button class="btn-fechar" (click)="fecharFatura()" title="Fechar">
        âœ•
      </button>
    </div>
  </div>

  <!-- Mensagem quando nÃ£o hÃ¡ faturas -->
  <div class="no-faturas" *ngIf="cartaoSelecionado && getCartaoSelecionado() && (!getCartaoSelecionado()!.faturas || getCartaoSelecionado()!.faturas!.length === 0)">
    <div class="no-faturas-content">
      <p>Este cartÃ£o ainda nÃ£o possui faturas</p>
      <button class="btn-fechar-no-faturas" (click)="fecharFatura()">Fechar</button>
    </div>
  </div>

  <!-- Modal de Detalhes da Fatura -->
  <div class="modal-overlay" *ngIf="modalDetalhesAberto" (click)="fecharModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalhes da Fatura</h3>
        <button class="btn-fechar-modal" (click)="fecharModal()" title="Fechar">
          âœ•
        </button>
      </div>

      <div class="modal-body">
        <div class="loading-detalhes" *ngIf="loadingDetalhes">
          <div class="spinner"></div>
          <p>Carregando detalhes...</p>
        </div>

        <div class="detalhes-content" *ngIf="!loadingDetalhes">
          <div class="empty-items" *ngIf="itensFatura.length === 0">
            <p>Nenhum lanÃ§amento encontrado nesta fatura.</p>
          </div>

          <div class="items-list" *ngIf="itensFatura.length > 0">
            <div class="item" *ngFor="let item of itensFatura">
              <div class="item-header">
                <h4 class="item-descricao">{{ item.descricao }}</h4>
                <span class="item-valor">{{ formatarMoeda(item.valor) }}</span>
              </div>
              <div class="item-footer">
                <span class="item-categoria">{{ item.categoria }}</span>
                <span class="item-data">{{ item.dataRegistro }}</span>
              </div>
              <div class="item-parcelas" *ngIf="item.parcelado">
                <span class="badge-parcelas">ðŸ“Š Parcelado em {{ item.numeroParcelas }}x</span>
              </div>
            </div>

            <div class="total-resumo">
              <div class="total-item">
                <span class="total-label">Total de LanÃ§amentos:</span>
                <span class="total-count">{{ itensFatura.length }}</span>
              </div>
              <div class="total-item">
                <span class="total-label">Valor Total:</span>
                <span class="total-valor">{{ calcularTotal() }}</span>
              </div>
            </div>
          </div>

          <!-- BotÃ£o para adicionar novo item -->
          <div class="adicionar-item-section">
            <button class="btn-adicionar-item" (click)="abrirFormularioItem()">
              <span class="icon-plus">+</span>
              Adicionar Item na Fatura
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Pagamento -->
  <div class="modal-overlay" *ngIf="modalPagamentoAberto" (click)="fecharModalPagamento()">
    <div class="modal-content modal-pagamento" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Pagar Fatura</h3>
        <button class="btn-fechar-modal" (click)="fecharModalPagamento()" title="Fechar">
          âœ•
        </button>
      </div>

      <div class="modal-body">
        <div class="pagamento-content">
          <div class="pagamento-info">
            <div class="info-item">
              <span class="info-label">CartÃ£o:</span>
              <span class="info-value">{{ getNomeCartao() }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">PerÃ­odo:</span>
              <span class="info-value">{{ getMesAnoFatura() }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Valor da Fatura:</span>
              <span class="info-value destaque">{{ getFaturaValor() }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Valor Pago:</span>
              <span class="info-value">{{ getValorPago() }}</span>
            </div>
          </div>

          <div class="pagamento-form">
            <div class="form-group">
              <label for="valorPagamento">Valor do Pagamento</label>
              <input
                type="number"
                id="valorPagamento"
                [(ngModel)]="valorPagamento"
                step="0.01"
                min="0.01"
                placeholder="0,00"
                class="input-valor"
              />
              <small class="helper-text">Informe o valor que deseja pagar</small>
            </div>

            <div class="pagamento-actions">
              <button
                class="btn-confirmar-pagamento"
                (click)="confirmarPagamento()"
                [disabled]="!valorPagamento || valorPagamento <= 0 || loadingPagamento">
                <span *ngIf="!loadingPagamento">ðŸ’³ Confirmar Pagamento</span>
                <span *ngIf="loadingPagamento">Processando...</span>
              </button>
              <button
                class="btn-cancelar-pagamento"
                (click)="fecharModalPagamento()"
                [disabled]="loadingPagamento">
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
