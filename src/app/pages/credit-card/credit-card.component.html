<div class="container">
  <div class="header">
    <h2>Cart√µes:</h2>
    <button class="btn-reload" (click)="recarregarDados()" [disabled]="loading">
      <span *ngIf="loading" class="spinning">üîÑ</span>
      <span *ngIf="!loading">‚Üª</span>
      {{ loading ? 'Carregando...' : 'Atualizar' }}
    </button>
  </div>

  <div class="cards" *ngIf="!loading && cartoes.length > 0">
    <div class="card"
         *ngFor="let cartao of cartoes"
         (click)="selecionarCartao(cartao.uuid)"
         [class.selected]="cartaoSelecionado === cartao.uuid"
         [class.desativado]="cartao.desativado">
      <div class="card-content">
        <div class="card-header-actions">
          <h4>{{ cartao.description }}</h4>
          <label class="checkbox-container" (click)="$event.stopPropagation()" title="Desativar cart√£o">
            <input
              type="checkbox"
              [(ngModel)]="cartao.desativado"
              (change)="toggleDesativarCartao($event, cartao)">
            <span class="checkbox-label">Desativar</span>
          </label>
        </div>
        <p class="card-bandeira">{{ cartao.flags.name }}</p>
        <p class="card-limite">Limite: {{ cartao.limite | currency:'BRL':'symbol':'1.2-2' }}</p>
        <p class="card-faturas" *ngIf="cartao.faturas && cartao.faturas.length > 0">
          {{ cartao.faturas.length }} fatura(s)
        </p>
        <p class="card-status" *ngIf="cartao.desativado">
          <span class="badge-desativado">‚ö†Ô∏è Desativado</span>
        </p>
      </div>
    </div>
    <div class="card create-card" routerLink="/create-card">
      <div class="card-content">
        <span class="plus-icon">+</span>
        <span>Criar Cart√£o</span>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="!loading && cartoes.length === 0">
    <div class="empty-icon">üí≥</div>
    <p>Voc√™ ainda n√£o possui cart√µes cadastrados</p>
    <button class="btn-create-first" routerLink="/create-card">
      Criar Primeiro Cart√£o
    </button>
  </div>

  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Carregando cart√µes...</p>
  </div>

  <!-- Bal√£o da fatura que aparece quando um cart√£o √© selecionado -->
  <div class="fatura" *ngIf="cartaoSelecionado && getFaturaAtual()">
    <!-- Header da fatura com navega√ß√£o -->
    <div class="fatura-header">
      <button
        class="nav-arrow nav-arrow-left"
        (click)="faturaAnterior()"
        [disabled]="!podeVoltar()"
        [class.disabled]="!podeVoltar()"
        title="Fatura anterior">
        &#8249;
      </button>

      <div class="fatura-title">
        <h3>{{ getNomeCartao() }}</h3>
        <p class="fatura-periodo">{{ getMesAnoFatura() }}</p>
      </div>

      <button
        class="nav-arrow nav-arrow-right"
        (click)="proximaFatura()"
        [disabled]="!podeAvancar()"
        [class.disabled]="!podeAvancar()"
        title="Pr√≥xima fatura">
        &#8250;
      </button>
    </div>

    <!-- Informa√ß√µes da fatura -->
    <div class="fatura-info">
      <div class="fatura-item">
        <span class="label">Valor da Fatura:</span>
        <span class="value valor-fatura" [class]="getStatusFatura().toLowerCase().replace(' ', '-')">
          {{ getFaturaValor() }}
        </span>
      </div>

      <div class="fatura-item">
        <span class="label">Valor Pago:</span>
        <span class="value valor-pago">
          {{ getValorPago() }}
        </span>
      </div>

      <div class="fatura-item">
        <span class="label">Data de Fechamento:</span>
        <span class="value">{{ getDataFechamento() }}</span>
      </div>

      <div class="fatura-item">
        <span class="label">Data de Vencimento:</span>
        <span class="value">{{ getDataVencimento() }}</span>
      </div>

      <div class="fatura-item">
        <span class="label">Limite Dispon√≠vel:</span>
        <span class="value limite">{{ getLimiteDisponivel() }}</span>
      </div>

      <div class="fatura-item">
        <span class="label">Status:</span>
        <span class="value status" [class]="getStatusFatura().toLowerCase().replace(' ', '-')">
          {{ getStatusFatura() }}
        </span>
      </div>
    </div>

    <!-- Indicador de navega√ß√£o (pontos) -->
    <div class="fatura-indicator" *ngIf="getCartaoSelecionado() && getCartaoSelecionado()!.faturas">
      <span
        *ngFor="let fatura of getCartaoSelecionado()!.faturas; let i = index"
        class="indicator-dot"
        [class.active]="i === faturaAtualIndex"
        [title]="fatura.mes + ' ' + fatura.ano"
        (click)="faturaAtualIndex = i">
      </span>
    </div>

    <!-- A√ß√µes da fatura -->
    <div class="fatura-actions">
      <button
        class="btn-pagar"
        (click)="pagarFatura()"
        [disabled]="getStatusFatura() === 'Pago' || getStatusFatura() === 'Futura'">
        <span *ngIf="getStatusFatura() === 'Pago'">‚úì Pago</span>
        <span *ngIf="getStatusFatura() === 'Futura'">Fatura Futura</span>
        <span *ngIf="getStatusFatura() === 'Fechamento Pendente'">Pagar Pend√™ncia</span>
        <span *ngIf="getStatusFatura() === 'Em aberto'">Pagar Fatura</span>
      </button>

      <button class="btn-detalhes" (click)="verDetalhes()">
        Ver Detalhes
      </button>

      <button class="btn-fechar" (click)="fecharFatura()" title="Fechar">
        ‚úï
      </button>
    </div>
  </div>

  <!-- Mensagem quando n√£o h√° faturas -->
  <div class="no-faturas" *ngIf="cartaoSelecionado && getCartaoSelecionado() && (!getCartaoSelecionado()!.faturas || getCartaoSelecionado()!.faturas!.length === 0)">
    <div class="no-faturas-content">
      <p>Este cart√£o ainda n√£o possui faturas</p>
      <button class="btn-fechar-no-faturas" (click)="fecharFatura()">Fechar</button>
    </div>
  </div>

  <!-- Modal de Detalhes da Fatura -->
  <div class="modal-overlay" *ngIf="modalDetalhesAberto" (click)="fecharModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalhes da Fatura</h3>
        <button class="btn-fechar-modal" (click)="fecharModal()" title="Fechar">
          ‚úï
        </button>
      </div>

      <div class="modal-body">
        <div class="loading-detalhes" *ngIf="loadingDetalhes">
          <div class="spinner"></div>
          <p>Carregando detalhes...</p>
        </div>

        <div class="detalhes-content" *ngIf="!loadingDetalhes">
          <div class="empty-items" *ngIf="itensFatura.length === 0">
            <p>Nenhum lan√ßamento encontrado nesta fatura.</p>
          </div>

          <div class="items-list" *ngIf="itensFatura.length > 0">
            <div class="item" *ngFor="let item of itensFatura">
              <div class="item-header">
                <h4 class="item-descricao">{{ item.descricao }}</h4>
                <span class="item-valor">{{ formatarMoeda(item.valor) }}</span>
              </div>
              <div class="item-footer">
                <span class="item-categoria">{{ item.categoria }}</span>
                <span class="item-data">{{ item.dataRegistro }}</span>
              </div>
              <div class="item-parcelas" *ngIf="item.parcelado">
                <span class="badge-parcelas">üìä Parcelado em {{ item.numeroParcelas }}x</span>
              </div>
            </div>

            <div class="total-resumo">
              <div class="total-item">
                <span class="total-label">Total de Lan√ßamentos:</span>
                <span class="total-count">{{ itensFatura.length }}</span>
              </div>
              <div class="total-item">
                <span class="total-label">Valor Total:</span>
                <span class="total-valor">{{ calcularTotal() }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
